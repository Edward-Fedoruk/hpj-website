---
import type { FormType } from "@/types/formTypes";

import SectionCorner from "../SectionCorner.astro";

interface Props {
  title: string;
  subTitle?: string;
  form?: FormType | null;
}

const { title, subTitle, form } = Astro.props;

const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";
const ENDPOINT = `${STRAPI_URL}/api/api-forms/submission/post`;
const FORM_ID = form?.documentId ?? "";
---

<section
  class="relative mx-auto flex flex-col gap-6 bg-[var(--color-dark-purple)] px-4 py-[100px] selection:bg-white! selection:text-[#524CF2]! md:items-center md:gap-8 md:py-[134px] xl:px-10"
>
  <SectionCorner className="text-[var(--color-gray-10)]" position="top-right" />
  <SectionCorner className="text-[#F7F7F7]" position="bottom-left" />
  <h1
    class="block max-w-[578px] text-center font-(family-name:--font-helvetica-bold) text-3xl font-bold tracking-tight text-balance whitespace-pre-line text-white sm:text-4xl lg:text-6xl lg:leading-tight dark:text-neutral-200"
  >
    <Fragment set:html={title} />
  </h1>
  {
    subTitle && (
      <p class="mx-auto w-full max-w-[578px] text-center text-lg leading-relaxed text-pretty text-[#FFFFFFB2]">
        {subTitle}
      </p>
    )
  }

  {
    form && (
      <form
        class="flex w-full flex-col items-center"
        data-endpoint={ENDPOINT}
        data-form-id={FORM_ID}
        onsubmit="return handleSubmit(event, this)"
      >
        <div class="relative flex w-full max-w-[436px] rounded-[10px] border border-[var(--color-primary)] bg-white p-1">
          <input
            type="text"
            name="honeypot_field"
            class="hidden"
            tabindex="-1"
            autocomplete="off"
          />

          <label for="emailaddress" class="sr-only">
            Email
          </label>
          <input
            id="emailaddress"
            type="email"
            autocomplete="email"
            name="emailaddress"
            placeholder="Email address"
            required
            class="w-[calc(100%-109px)] border-0 py-0 ring-0 outline-0"
          />

          <button
            type="submit"
            class="flex h-[48px] w-full max-w-[109px] items-center justify-center rounded-[10px] bg-[var(--color-primary)] text-lg font-semibold text-white"
          >
            Send
          </button>
        </div>

        <p
          id="status"
          class="h-5 pt-[10px] text-sm text-[#FFFFFFCC]"
          aria-live="polite"
        />
      </form>
    )
  }
</section>

<script is:inline>
  async function handleSubmit(ev, form) {
    ev.preventDefault();

    const honey = (
      form.querySelector('[name="honeypot_field"]')?.value || ""
    ).trim();
    if (honey) return false;

    const endpoint = form.dataset.endpoint;
    const formId = form.dataset.formId;
    const emailEl = form.querySelector("#emailaddress");
    const btn = form.querySelector('button[type="submit"]');
    const statusEl = form.querySelector("#status");

    const email = (emailEl?.value || "").trim();
    if (!email) {
      statusEl.textContent = "Enter email";
      return false;
    }

    btn.disabled = true;
    statusEl.textContent = "Sending...";

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          form: formId,
          submission: { emailaddress: email },
        }),
      });

      if (!res.ok) throw new Error(await res.text());

      form.reset();
      statusEl.textContent = "Sent. Check your inbox.";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Failed. Try again.";
    } finally {
      btn.disabled = false;
    }
    return false;
  }
</script>

<style>
  section {
    background:
      radial-gradient(
        43.44% 43.44% at 50% 110%,
        #524cf2 15.73%,
        rgba(82, 76, 242, 0) 100%
      ),
      #0a0d27;
  }
  @media screen and (max-width: 768px) {
    section {
      background:
        radial-gradient(
          70% 40% at 50% 100%,
          #524cf2 15.73%,
          rgba(82, 76, 242, 0) 100%
        ),
        #0a0d27;
    }
  }
</style>
