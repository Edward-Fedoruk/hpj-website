---
import { DynamicPageHandler } from "@/gql/services/dynamic-page-handler";

import { sections as components } from "@/components/sections/index.ts";

import MainLayout from "@/layouts/MainLayout.astro";
import type { SectionType } from "@/types/sectionTypes";

type CMSSection = Record<string, any>;

export async function getStaticPaths() {
  const dynamicPageHandler = new DynamicPageHandler();
  const cmsResponse = await dynamicPageHandler.getDynamicPageData();

  return cmsResponse.pages.map(({ slug, title, seoTitle, seoDescription, sections, isIndexable, documentId, customFooterImage }) => {
    return {
      params: { path: slug === "/home" ? "/" : slug },
      props: {
        title,
        seoTitle,
        seoDescription,
        cmsSections: sections,
        isIndexable,
        documentId,
        customFooterImage
      },
    };
  });
}

const { cmsSections = [], seoTitle, seoDescription, customFooterImage } = Astro.props;

const blocks = cmsSections.map((s: CMSSection) => {
  const key = s.componentId;
  const C = components[key as SectionType];
  return { C, props: s, key };
});
---

<html>
  <head>
    <title>{seoTitle}</title>
    <meta name="description" content={seoDescription ?? ""} />
  </head>

  <body>
    <main>
      <MainLayout customFooterImage={customFooterImage}>
        {blocks.length === 0 && <h1>Empty page</h1>}

        {
          blocks.map(({ C, props, key }, i) => {
            return C ? <C {...props} key={key ?? i} /> : null;
          })
        }
      </MainLayout>
    </main>
  </body>
</html>
