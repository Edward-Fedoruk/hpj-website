---
import type { FormType, FormLayoutType } from "@/types/formTypes";
import '@styles/forms.css';

interface BU {
  documentId: string;
  title: string;
}
interface Props {
  blockTitle: string;
  blockSubtitle: string;
  email: string;
  address: string;
  workingTime: string;
  phone: string;
  formTitle: string;
  formSubTitle?: string;
  form?: FormType | null;
  submitBtnLabel?: string | null;
  businessUnitsForFormSelect?: BU[] | null;
}

const { blockTitle, blockSubtitle, email, address, workingTime, phone, formTitle, formSubTitle, form, submitBtnLabel, businessUnitsForFormSelect = [] } = Astro.props;

const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";
const ENDPOINT = `${STRAPI_URL}/api/api-forms/submission/post`;
const FORM_ID = form?.documentId ?? "";

const layouts = (form as any)?.steps?.[0]?.layouts ?? null;

function byIdMap(arr: FormLayoutType[] | undefined) {
  const m = new Map<string, FormLayoutType>();
  (arr ?? []).forEach((it) => m.set(it.i, it));
  return m;
}
const lgMap = byIdMap(layouts?.lg);
const mdMap = byIdMap(layouts?.md);
const smMap = byIdMap(layouts?.sm);

const order = layouts?.lg?.length ? layouts.lg : layouts?.md?.length ? layouts.md : (layouts?.sm ?? []);

function pos(id: string) {
  const lg = lgMap.get(id) ?? mdMap.get(id) ?? smMap.get(id);
  const md = mdMap.get(id) ?? smMap.get(id) ?? lgMap.get(id);
  const sm = smMap.get(id) ?? mdMap.get(id) ?? lgMap.get(id);
  return {
    lgx: lg?.x ?? 0,
    lgw: lg?.w ?? 12,
    mdx: md?.x ?? 0,
    mdw: md?.w ?? 12,
    smx: sm?.x ?? 0,
    smw: sm?.w ?? 12,
  };
}

const BU_OPTIONS = (businessUnitsForFormSelect ?? []).map((u) => ({
  value: u.title,
  label: u.title,
}));

---

<section
  class="header-text-dark relative flex flex-col lg:flex-row gap-6 bg-white px-4 py-[100px] max-w-7xl mx-auto md:items-start md:py-[134px] xl:px-0 md:justify-between"
>
  <div class="flex flex-col max-w-[628px] flex-1">
    <h1
      class="block text-left text-3xl leading-[120%] font-black text-balance whitespace-pre-line text-text-main lg:text-[40px]"
    >
      <Fragment set:html={blockTitle} />
    </h1>
    {
      blockSubtitle && (
        <p class="mt-6 w-full text-left text-lg text-text-main">{blockSubtitle}</p>
      )
    }

    <ul class="flex flex-col gap-6 mt-8">
      {
        email && (
          <li class="flex flex-row gap-4">
            <svg class="min-w-6 w-6" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 8C18.1667 8 17.4583 7.70833 16.875 7.125C16.2917 6.54167 16 5.83333 16 5C16 4.16667 16.2917 3.45833 16.875 2.875C17.4583 2.29167 18.1667 2 19 2C19.8333 2 20.5417 2.29167 21.125 2.875C21.7083 3.45833 22 4.16667 22 5C22 5.83333 21.7083 6.54167 21.125 7.125C20.5417 7.70833 19.8333 8 19 8ZM4 20C3.45 20 2.97917 19.8042 2.5875 19.4125C2.19583 19.0208 2 18.55 2 18V6C2 5.45 2.19583 4.97917 2.5875 4.5875C2.97917 4.19583 3.45 4 4 4H14.1C14.0333 4.33333 14 4.66667 14 5C14 5.33333 14.0333 5.66667 14.1 6C14.2167 6.53333 14.4083 7.02917 14.675 7.4875C14.9417 7.94583 15.2667 8.35 15.65 8.7L12 11L4 6V8L12 13L17.275 9.7C17.5583 9.8 17.8417 9.875 18.125 9.925C18.4083 9.975 18.7 10 19 10C19.5333 10 20.0583 9.91667 20.575 9.75C21.0917 9.58333 21.5667 9.33333 22 9V18C22 18.55 21.8042 19.0208 21.4125 19.4125C21.0208 19.8042 20.55 20 20 20H4Z" fill="#4A4A4A"/>
            </svg>
            <span class="text-text-main text-base font-normal">{email}</span>
          </li>
        )
      }
      {
        phone && (
          <li class="flex flex-row gap-4">
            <svg class="min-w-6 w-6" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6.62 10.79C8.06 13.62 10.38 15.93 13.21 17.38L15.41 15.18C15.68 14.91 16.08 14.82 16.43 14.94C17.55 15.31 18.76 15.51 20 15.51C20.55 15.51 21 15.96 21 16.51V20C21 20.55 20.55 21 20 21C10.61 21 3 13.39 3 4C3 3.45 3.45 3 4 3H7.5C8.05 3 8.5 3.45 8.5 4C8.5 5.25 8.7 6.45 9.07 7.57C9.18 7.92 9.1 8.31 8.82 8.59L6.62 10.79Z" fill="#4A4A4A"/>
            </svg>
            <span class="text-text-main text-base font-normal">{phone}</span>
          </li>
        )
      }
      {
        workingTime && (
          <li class="flex flex-row gap-4">
            <svg class="min-w-6 w-6" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C10.6868 2 9.38642 2.25866 8.17317 2.7612C6.95991 3.26375 5.85752 4.00035 4.92893 4.92893C3.05357 6.8043 2 9.34784 2 12C2 14.6522 3.05357 17.1957 4.92893 19.0711C5.85752 19.9997 6.95991 20.7362 8.17317 21.2388C9.38642 21.7413 10.6868 22 12 22C14.6522 22 17.1957 20.9464 19.0711 19.0711C20.9464 17.1957 22 14.6522 22 12C22 10.6868 21.7413 9.38642 21.2388 8.17317C20.7362 6.95991 19.9997 5.85752 19.0711 4.92893C18.1425 4.00035 17.0401 3.26375 15.8268 2.7612C14.6136 2.25866 13.3132 2 12 2ZM16.2 16.2L11 13V7H12.5V12.2L17 14.9L16.2 16.2Z" fill="#4A4A4A"/>
            </svg>
            <span class="text-text-main text-base font-normal">{workingTime}</span>
          </li>
        )
      }
      {
        address && (
          <li class="flex flex-row gap-4">
            <svg class="min-w-6 w-6" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 11.5C11.337 11.5 10.7011 11.2366 10.2322 10.7678C9.76339 10.2989 9.5 9.66304 9.5 9C9.5 8.33696 9.76339 7.70107 10.2322 7.23223C10.7011 6.76339 11.337 6.5 12 6.5C12.663 6.5 13.2989 6.76339 13.7678 7.23223C14.2366 7.70107 14.5 8.33696 14.5 9C14.5 9.3283 14.4353 9.65339 14.3097 9.95671C14.1841 10.26 13.9999 10.5356 13.7678 10.7678C13.5356 10.9999 13.26 11.1841 12.9567 11.3097C12.6534 11.4353 12.3283 11.5 12 11.5ZM12 2C10.1435 2 8.36301 2.7375 7.05025 4.05025C5.7375 5.36301 5 7.14348 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 7.14348 18.2625 5.36301 16.9497 4.05025C15.637 2.7375 13.8565 2 12 2Z" fill="#4A4A4A"/>
            </svg>
            <span class="text-text-main text-base font-normal">{address}</span>
          </li>
        )
      }
    </ul>
  </div>

  <div class="z-10 mx-auto flex w-full flex-col md:items-center flex-[0_1_50%] max-w-[628px] lg:mx-0 p-4 md:p-12 shadow-card rounded-xl">
    <h1
      class="block max-w-[578px] text-center text-3xl leading-[110%] font-black text-balance whitespace-pre-line text-text-main lg:text-[52px]"
    >
      <Fragment set:html={formTitle} />
    </h1>

    {formSubTitle && <p class="mt-3 mx-auto w-full max-w-[578px] text-center text-lg text-text-secondary">{formSubTitle}</p>}

    {
      layouts && (
        <form
          class="flex w-full flex-col items-center mt-8"
          data-endpoint={ENDPOINT}
          data-form-id={FORM_ID}
          data-success-message={form?.successMessage || "Your message has been sent successfully."}
          data-error-message={form?.errorMessage || "There was an error submitting the form. Please try again."}
          onsubmit="return GetInTouchFormhandleSubmit(event, this)"
        >
          <div class="flex w-full flex-col items-center">
            <input type="text" name="honeypot_field" class="hidden" tabindex="-1" autocomplete="off" />

            <div class="grid12 w-full max-w-[920px] gap-4">
              {order.map((it: FormLayoutType) => {
                const p = pos(it.i);
                const f = it.field;
                const required = f.config?.required ? true : undefined;

                const isBUSelect = f.type === "select" && f.name === "businessUnit";
                const selectOptions = isBUSelect ? BU_OPTIONS : (f.options ?? []);

                return (
                  <div
                    class="cell flex flex-col"
                    style={
                      {
                        "--x-sm": p.smx,
                        "--w-sm": p.smw,
                        "--x-md": p.mdx,
                        "--w-md": p.mdw,
                        "--x-lg": p.lgx,
                        "--w-lg": p.lgw,
                      } as any
                    }
                  >
                    {f.type === "text" || f.type === "email" ? (
                      <label class="flex flex-col gap-1">
                        <span class="label">
                          {f.label}
                          {required && <sup class="req">*</sup>}
                        </span>
                        <input
                          id={f.name}
                          type={f.type}
                          name={f.name}
                          placeholder={f.placeholder || ""}
                          required={required}
                          class="input"
                        />
                      </label>
                    ) : f.type === "textarea" ? (
                      <label class="flex flex-col gap-1">
                        <span class="label">
                          {f.label}
                          {required && <sup class="req">*</sup>}
                        </span>
                        <textarea
                          name={f.name}
                          placeholder={f.placeholder || ""}
                          required={required}
                          class="input min-h-[120px]"
                        />
                      </label>
                    ) : f.type === "file" ? (
                      <label class="flex flex-col gap-1">
                        <span class="label">
                          {f.label}
                          {required && <sup class="req">*</sup>}
                        </span>
                        <input type="file" name={f.name} required={required} class="fileinput" />
                      </label>
                    ) : f.type === "select" ? (
                      <label class="flex flex-col gap-1">
                        <span class="label">
                          {f.label}
                          {required && <sup class="req">*</sup>}
                        </span>
                        <select name={f.name} required={required} class="input">
                          <option value="" disabled selected>
                            {f.placeholder || "Select"}
                          </option>
                          {selectOptions.map((opt) => (
                            <option value={opt.value}>{opt.label}</option>
                          ))}
                        </select>
                      </label>
                    ) : f.type === "checkboxgroup" ? (
                      <fieldset class="flex flex-col gap-2">
                        <legend class="label">
                          {f.label}
                          {required && <sup class="req">*</sup>}
                        </legend>
                        <div class="grid grid-cols-1 gap-2 md:grid-cols-2">
                          {(f.options ?? []).map((opt) => (
                            <label class="inline-flex items-center gap-2 text-text-main">
                              <input type="checkbox" name={`${f.name}[]`} value={opt.value} class="h-4 w-4" />
                              <span>{opt.label}</span>
                            </label>
                          ))}
                        </div>
                      </fieldset>
                    ) : (
                      <div class="text-sm text-amber-300">
                        Unsupported field: <code>{f.type}</code>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            <button
              type="submit"
              class="mt-6 flex h-14 w-full items-center justify-center rounded-[10px] bg-primary text-lg font-semibold text-white disabled:cursor-not-allowed disabled:opacity-60"
            >
              {submitBtnLabel ?? "Submit"}
            </button>

            <p id="status" class="h-5 pt-[10px] text-sm text-[#FFFFFFCC]" aria-live="polite" />
          </div>
        </form>
      )
    }
    <p class="mt-2 text-text-main">By contacting us you agree to our <a href="/terms-and-conditions" target="_blank"  class="underline underline-offset-3 cursor-pointer">Terms & Conditions</a> and <a href="/privacy-policy" target="_blank" class="underline underline-offset-3 cursor-pointer">Privacy Policy</a>.</p>
  </div>
</section>

<script is:inline>
  async function GetInTouchFormhandleSubmit(ev, formElement) {
    ev.preventDefault();
    const statusEl = formElement.querySelector("#status");
    const setStatus = (m) => (statusEl.textContent = m || "");

    // honeypot
    const honey = (formElement.querySelector('[name="honeypot_field"]')?.value || "").trim();
    if (honey) return false;

    const endpoint = formElement.dataset.endpoint;
    const formId = formElement.dataset.formId;
    if (!formId) {
      setStatus("Form ID is missing");
      return false;
    }

    const emailEl = formElement.querySelector('input[type="email"], input[name*="email" i]');
    if (!emailEl || !emailEl.value.trim()) {
      setStatus("Enter email");
      emailEl?.focus();
      return false;
    }

    const fd = new FormData();
    fd.append("form", formId);

    const inputs = formElement.querySelectorAll('input[type="text"], input[type="email"], textarea, select');
    for (const el of inputs) {
      const name = el.name?.trim();
      if (!name) continue;
      const val = el.value?.trim?.() ?? el.value ?? "";
      if (val) fd.append(`submission[${name}]`, val);
    }

    const btn = formElement.querySelector('button[type="submit"]');
    btn?.setAttribute("disabled", "true");
    setStatus("Sending...");

    try {
      const res = await fetch(endpoint, { method: "POST", body: fd });
      if (!res.ok) throw new Error(await res.text());
      formElement.reset();
      setStatus(formElement.dataset.successMessage);
    } catch (err) {
      console.error(err);
      setStatus(formElement.dataset.errorMessage);
    } finally {
      btn?.removeAttribute("disabled");
    }
    return false;
  }
</script>
