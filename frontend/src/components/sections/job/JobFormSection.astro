---
import FormLayout from "@/components/ui/forms/FormLayout.astro";
import type { FormType, FormLayoutType } from "@/types/formTypes";
import '@styles/forms.css';

interface Props {
  title: string;
  job?: {
    jobID:string
  }
  subTitle?: string;
  form?: FormType | null;
  submitBtnLabel?: string | null;
}

const { title, subTitle, form, submitBtnLabel, job } = Astro.props;

const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || "http://localhost:1337";
const ENDPOINT = `${STRAPI_URL}/api/api-forms/submission/post`;
const FORM_ID = form?.documentId ?? "";

const JOB_ID = job?.jobID ?? null;

const layouts = (form as any)?.steps?.[0]?.layouts ?? null;

function byIdMap(arr: FormLayoutType[] | undefined) {
  const m = new Map<string, FormLayoutType>();
  (arr ?? []).forEach((it) => m.set(it.i, it));
  return m;
}
const lgMap = byIdMap(layouts?.lg);
const mdMap = byIdMap(layouts?.md);
const smMap = byIdMap(layouts?.sm);

const order = layouts?.lg?.length ? layouts.lg : layouts?.md?.length ? layouts.md : (layouts?.sm ?? []);

function pos(id: string) {
  const lg = lgMap.get(id) ?? mdMap.get(id) ?? smMap.get(id);
  const md = mdMap.get(id) ?? smMap.get(id) ?? lgMap.get(id);
  const sm = smMap.get(id) ?? mdMap.get(id) ?? lgMap.get(id);
  return {
    lgx: lg?.x ?? 0,
    lgw: lg?.w ?? 12,
    mdx: md?.x ?? 0,
    mdw: md?.w ?? 12,
    smx: sm?.x ?? 0,
    smw: sm?.w ?? 12,
  };
}
---

<section
  id="job-form-section"
  class="header-text-dark bg-[#f5f5f5] relative mx-auto flex flex-col gap-6 md:px-4 py-[100px] md:items-center md:gap-8 md:py-[134px] xl:px-10"
>
  <div class="bg-white shadow-card px-5 py-12 md:p-12 max-w-[846px] w-full rounded-xl flex flex-col items-center">
    <h1
      class="mx-auto block max-w-[578px] text-center text-3xl leading-[120%] font-black text-balance whitespace-pre-line text-text-main lg:text-[52px]"
    >
      <Fragment set:html={title} />
    </h1>

    {subTitle && <p class="mt-3 mx-auto w-full max-w-[578px] text-center text-lg text-text-main">{subTitle}</p>}

    {
      form && <FormLayout form={form} formId="job-form" submitBtnLabel={submitBtnLabel ? submitBtnLabel : "Apply Now"} submitButtonClassName="md:max-w-[300px]" />
    }
  </div>
  
</section>



<script is:inline>
  function cvInputFieldHandler(inputElement) {
    if (!inputElement) return

    const placeholderElement = inputElement?.closest('label').querySelector(".placeholder");

    if (inputElement.files.length > 0) {
      placeholderElement.querySelector('p').textContent = "Chosen file: " + Array.from(inputElement.files).map(file => file.name).join(', ')
    } else {
      placeholderElement.querySelector('p').textContent = "CV Upload";
    }
  }

  async function CVFormhandleSubmit(ev, formElement) {
    ev.preventDefault();
    const statusEl = formElement.querySelector("#status");
    const setStatus = (m) => (statusEl.textContent = m || "");

    const honey = (formElement.querySelector('[name="honeypot_field"]')?.value || "").trim();
    if (honey) return false;

    const endpoint = formElement.dataset.endpoint;
    const formId = formElement.dataset.formId;
    if (!formId) return setStatus("Form ID is missing");

    const emailEl = formElement.querySelector('input[type="email"], input[name*="email" i]');
    const nameEl = formElement.querySelector('input[name*="name" i]');
    if (!emailEl || !emailEl.value.trim()) {
      setStatus("Enter email");
      emailEl?.focus();
      return false;
    }
    if (!nameEl || !nameEl.value.trim()) {
      setStatus("Enter your name");
      nameEl?.focus();
      return false;
    }

    const checkboxes = formElement.querySelectorAll('input[type="checkbox"]');
    const checkedBoxes = formElement.querySelectorAll('input[type="checkbox"]:checked');
    if (checkboxes.length > 0 && checkedBoxes.length === 0) {
      setStatus("Please select at least one option");
      checkboxes[0]?.focus();
      return false;
    }

    const fileInputs = formElement.querySelectorAll('input[type="file"]');
    const hasFileInputs = fileInputs.length > 0;
    const hasSelectedFile = [...fileInputs].some((i) => i.files?.length > 0);
    if (hasFileInputs && !hasSelectedFile) {
      setStatus("Please upload a file before submitting");
      fileInputs[0].focus();
      return false;
    }

    const fd = new FormData();
    fd.append("form", formId);

    const inputs = formElement.querySelectorAll('input[type="text"], input[type="email"], textarea');
    for (const el of inputs) {
      const name = el.name?.trim();
      if (!name) continue;
      const val = el.value?.trim();
      if (val) fd.append(`submission[${name}]`, val);
    }

    for (const cb of checkboxes) {
      const name = cb.name?.replace("[]", "").trim();
      if (!name) continue;
      if (cb.checked) fd.append(`submission[${name}][]`, cb.value ?? "on");
    }

    for (const inp of fileInputs) {
      const name = inp.name?.trim();
      if (!name || !inp.files) continue;
      for (const f of inp.files) {
        fd.append(`files[${name}]`, f, f.name);
      }
    }

    const btn = formElement.querySelector('button[type="submit"]');
    btn?.setAttribute("disabled", "true");
    setStatus("Sending...");

    try {
      const res = await fetch(endpoint, { method: "POST", body: fd });
      if (!res.ok) throw new Error(await res.text());
      formElement.reset();
      setStatus(formElement.dataset.successMessage);
    } catch (err) {
      console.error(err);
      setStatus(formElement.dataset.errorMessage);
    } finally {
      btn?.removeAttribute("disabled");
    }

    return false;
  }
</script>

<script is:inline>
  function hiddenInputFieldHandler() {
    const hiddenInputs = document.querySelectorAll('form input[type="hidden"]')

    if (!hiddenInputs.length) return

    hiddenInputs.forEach((input) => {
      const formElement = input.closest('form')
      if (!formElement) return

      if (formElement.dataset?.jobid && input.name.toLowerCase() === 'jobid') {
        input.value = formElement.dataset.jobid
      }
    })
  }
  
  window.addEventListener('load', () => {
    hiddenInputFieldHandler()
  })
</script>
